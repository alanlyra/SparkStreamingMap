<!DOCTYPE html>
<meta charset="utf-8">

<html>
  <head>
    <meta charset="UTF-8">
  	<meta charset="UTF-8">
  	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  	<meta http-equiv="X-UA-Compatible" content="ie=edge">
  	<link rel="stylesheet" href="css/normalize.css">
  	<link rel="stylesheet" href="css/style.css">
  	<title>Trabalho Big Data</title>
    <link href="./css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <link rel="stylesheet" href="./css/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css'>
    <link rel="stylesheet" href="css/style-map.css">
    <script src="https://maps.google.com/maps/api/js?sensor=false&"></script>
    <!-- <script src="dir.php"></script> -->

  </head>

<body style="padding:0px;">
	<div class="site">
		<header class="l-cabecalho">
 				<div class="container">
				  <table width=100%> <tr class="menubar"> <td width=100% style="background-color:#1abc9c"> <table> <tr>
    		</div>
      </div></tr></table></td></tr></table></div>
		</header>
		<main>
			<header class="main-header">
			</header>

			<div class="container" >

        <p>
          <input type="text" id="amount" readonly style="border:0; color:#06928a; font-weight:bold; text-align: center; font-size: 16px;">
        </p>

				<table>
  				<tr>
  				    <td width=470 valign=top>
          				<!-- Map Panel-->
                   <div id="map"></div>

                  <!-- <div id="csvdata"> -->
  				    </td>
  				</tr>
				</table>
			</div>
		</main>
		<footer class="l-footer">
      	<span class="versao-sistema">  </span>
        <img src="images/logo-fetranspor.png" alt="FETRANSPOR" class="logo-desfensoria" style="width:120px; height:"90px"">
        <img src="images/logo-coppe.png" alt="COPPE" class="logo-desfensoria" style="width:120px; height:"90px"">
    </footer>
	</div>
</body>

<script src="./js/jquery/jquery-2.1.4.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>



<script>

    var positions;
    var map;
    var locations;
    var infowindow;
    var markers = [];


    function reload(async){
      $.ajax({
          async: async,
          url: 'dir.php',
          type: 'post',
          data: { "callFunc1": "../exec/out/"},
          success: function(response) {
            $.ajax({
              async: async,
              type: "GET",
              //url: "0.csv",
              url: "../exec/out/"+response,
              dataType: "text",
              success: function(csv) {
              //toJSON function here
              csvJSON(csv);
              addMarker();
              }
            });
          }
      });
    }

    function csvJSON(csv){
      positions = null;
      var lines=csv.split("\n");
      var result = [];
      var headers=lines[0].split(",");
      for(var i=1;i<lines.length;i++){
    	  var obj = {};
    	  var currentline=lines[i].split(",");
    	  for(var j=0;j<headers.length;j++){
    		  obj[headers[j]] = currentline[j];
    	  }
    	  result.push(obj);
      }

      positions = result;
    }


</script>

<script>
  $(function(){
    reload(false);
    $( "#amount" ).val( "BRT - Linha 42" );
    locations = [];

    for(chave in positions){

      if(positions[chave]["linha"] == "42"){
        locations.push(['<b> Linha: ' + positions[chave]["linha"] + '</b><br> Veículo: ' + positions[chave]["codigo"], positions[chave]["latitude"], positions[chave]["longitude"], 2, "https://maps.google.com/mapfiles/ms/micons/bus.png"]);
      }

    }
    map = new google.maps.Map(document.getElementById('map'), {
      zoom: 11,
      center: new google.maps.LatLng(-22.970722, -43.182365), //Copacabana LatLong
      mapTypeId: google.maps.MapTypeId.ROADMAP
    });
    infowindow = new google.maps.InfoWindow();
    var timer = setInterval(recarregar, 5000);
  });

   function recarregar() {
     reload(true);
   }
  function deleteMarkers() {
    for (var i = 0; i < markers.length; i++) {
      markers[i].setMap(null);
    }
  }


  function addMarker(){
    if (typeof markers !== 'undefined') {
      deleteMarkers();
    }
    var marker, i;
    if (typeof locations !== 'undefined') {
      locations = [];
      for(chave in positions){

          locations.push(['<b> Linha: ' + positions[chave]["linha"] + '</b><br> Veículo: ' + positions[chave]["codigo"], positions[chave]["latitude"], positions[chave]["longitude"], 2, "https://maps.google.com/mapfiles/ms/micons/bus.png"]);
          console.log(positions);

      }
      for (i = 0; i < locations.length; i++) {
        marker = new google.maps.Marker({
          position: new google.maps.LatLng(locations[i][1], locations[i][2]),
          icon: locations[i][4],
          map: map
        });
        markers.push(marker);
        google.maps.event.addListener(marker, 'click', (function (marker, i) {
          return function () {
            infowindow.setContent(locations[i][0]);
            infowindow.open(map, marker);
          }
        })(marker, i));
      }
    }

  }

</script>
